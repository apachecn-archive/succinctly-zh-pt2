# 第十章小组

在前面的章节中，我们探索了用正则表达式进行搜索，但是没有对结果做太多的处理；我们只是检查条件是否满足，并可能使用结果来说明在 RTF 控件中找到文本的位置。在接下来的几章中，我们将集中讨论如何使用结果进行进一步的处理，例如数据清理、文本替换等。

## Regex 组

正则表达式中的组是更大的正则表达式中的嵌入正则表达式。您可以命名这些组，或者通过集合中的数字位置来引用它们。通过使用组，您可以对一个字符串执行多个操作并收集多个结果。您还可以从表达式中引用其他组，以搜索重复的单词等。

## 捕捉群体

要创建一个组来捕获模式，必须在括号中包含一个正则表达式。这将在整个模式中创建一个子表达式模式。子表达式可以是括号内的任何有效正则表达式模式。例如，如果我们取一个非常简单的`\({0,1}\d{3}\){0,1}[/\\ -]\d{3}-\d{4}`的电话号码模式，它将匹配以下形式的电话号码:

*   610-555-1212
*   (215) 555-1212
*   609\555-1212

但是，我们的要求是将电话号码拆分为区号和电话号码。虽然该模式将检测有效号码，但我们不知道区号和电话号码是什么。通过使用组，我们可以搜索电话号码，并将它们分成两个组成部分。

```
      \({0,1}(\d{3})\){0,1}[/\\ -](\d{3}-\d{4})

```

通过在区号和电话号码模式周围放置括号，我们现在不仅获得有效的电话号码，而且电话号码被分成两部分，每个子模式一个。每个组件被称为一个组，组从左到右编号，从索引 1 开始。

| ![](../Images/note.png) | 注意:Regex 组从索引 1 开始，而不是像大多数一样从 0 开始。NET 集合确实如此；使用 regex 时，请记住这一点。 |

当我们现在处理这个正则表达式时(使用 match 获取 match 对象)，Match 对象将包含一个名为 Groups 的集合属性。在本例中，将有两组:第 1 组包含区号数字，第 2 组包含实际电话号码。

### 命名组

微软。NET 框架(和其他正则表达式引擎)允许您给子表达式中的组分配名称。要为组指定名称，可以使用以下两种方法之一:

*   (**？<名称>** 正则表达式)
*   (? **'name'** 正则表达式)

您可以使用`\k<name>`或`\k’name’`语法在表达式中按名称引用该组。我们可以在电话号码表达式中添加姓名，如下所示:

```
      s\({0,1}(?<areacode>\d{3})\){0,1}[/\\ -](?<number>\d{3}-\d{4})

```

使用命名方法时，匹配对象的 group 属性可以通过名称(区分大小写)或索引号来引用。在上例中，组[1]和组[“区号”]都指同一个捕获组。但是有一点需要注意，任何未命名的组都将在命名的组之前，所以如果我们使用以下模式:

```
      \({0,1}(?<areacode>\d{3})\){0,1}[/\\ -](\d{3}-\d{4})

```

电话号码是 1 组，区号是 2 组。为了避免这个问题，我建议与组命名保持一致；您应该命名所有组或不命名任何组。组名可以提高正则表达式的可读性，尤其是当大多数正则表达式引擎支持多达 99 个带有模式的组时。

| ![](../Images/note.png) | 注意:组的命名是正则表达式引擎经常变化的一个方面。Python 的正则表达式引擎使用？P <name>语法来命名组和？p =引用它们的名称。Python 是第一个提供命名组的，但是没有设置标准，离开了。NET 工程师定义他们自己的组名语法。</name> |

### 多组

您可以使用组和量词创建正则表达式；但是，regex 引擎只会将最后一个匹配放入组中。例如，如果我们使用下面的表达式，我们要求从一个 SQL 函数调用中获取函数名和所有参数(为了简单起见，删除了参数数据类型)。

```
      (?<Method>\w*\()(?<Parameter>@\w*[,)])+

```

如果我们针对这个示例函数运行代码:

```
      Function GetName(@ObjId,@runDate) as INT
      BEGIN

      END

```

我们会让两个小组回来。第一组名为<method>，包含 **GetName(** )，第二组<参数>，包含 **@runDate)** 。只有最后一个参数将被分配给该组。</method>

幸运的是，微软正则表达式还会保存所有符合搜索模式的文本。虽然只有最后一个将被放入组对象中，但其他的将被放入组的捕获集合中。

| ![](../Images/tip.png) | 提示:捕获集合是从零开始的，而组集合是从一开始的。如果您需要同时处理这两个系列，请记住这一点。 |

### 回溯参考

您的正则表达式可以使用反向引用来引用捕获组。由于每个组都有编号(从左到右从一个开始)，因此您可以通过一个反斜杠后跟一个组号，或者命名组的\k <name>语法来引用一个组。</name>

例如，让我们考虑如何编写一个正则表达式模式来检测句子中重复的单词。用英语来描述，我们会说:先得到第一个单词，然后是下一个单词。如果下一个单词和前一个单词相同，就报告它。

表 13:反向参考

| 英国规则 | 正则模式 |
| 找到一个词 | (\w+) |
| 空格或逗号 | [\s，] |
| 我们找到的最后一个词 | (\1) |

如果我们现在在测试程序中写下以下句子:

`She thought her test was very, very unfair`

`However, her professor said the the test was actually pretty easy`

如果我们应用`(\w+)[\s,](\1)`的正则表达式模式，我们会看到以下结果:

`She thought her test was`非常非常`unfair`

`However, her professor said`该`test was actually pretty easy`了

您不需要使反向引用成为一个组，因为模式`(\w+)[\s,]\1`会给出相同的结果；但是，没有关于字符串中第二个重复单词的信息。

## 0 组

正则表达式引擎有一个组 0，它是整个正则表达式的模式(就像你把圆括号放在整个表达式周围一样)。如果您在您的模式中使用组，您可能根本不需要引用组 0，但是它可以方便地获得由整个表达式计算的捕获。

| ![](../Images/note.png) | 注意:在我们的 regex tester 程序中，我们在树形视图显示中隐藏了组 0，但是您可以替换`if`(组名！= `"0"`)与`if`(真)一起显示组 0 详细信息并在树形视图中捕捉信息。 |

### 不存在的组

如果试图引用一个不存在的组，该组对象将为 **Success** 属性返回一个 false 值。您可能还有一个空组，这是模式中请求的组，但在搜索字符串中从未找到。例如，如果我们要验证一个电话号码，我们可能需要寻找左括号来开始区号；如下所示:

```
      (\()?

```

寻找括号字符零或一次。如果找到左括号，它将被放在一个数字组中。您需要捕获该组供以后参考，以确定是否找到了括号(并因此寻找匹配的右括号)。

### 分组测试

您可以使用正则表达式条件模式来测试一个组是否有值。图案由`(?(group number or name)<pattern>)`表示。这个构造说，如果找到了这个组，应用指定的模式。如果没有，那就什么都不做。您也可以使用|字符作为 else 语句，以防您希望在找到组时使用一种模式，而在找不到组时使用另一种模式。一般语法如下:

```
      (? (group name or number) <true-pattern>|<false-pattern)

```

### 转发参考

前向引用是在模式中它引用的组之前找到的组引用号。regex 引擎可以处理前向引用和后向引用。

## 非捕获组

通常，当您使用组构造创建子模式时，您希望对组做一些事情。然而，很有可能你需要为搜索目的分组，但不要计划使用它。出现这种情况时，您应该使用非捕获组，它是参与搜索但不能在模式中引用的组。regex 组集合中不会返回非捕获组。

### 创建非捕获组

要创建非捕获组，可以使用模式`(?: <pattern>)`语法。如果永远不会引用组(通过反向引用或在 regex 对象的组集合中)，则应该创建非捕获组。

保存组会带来一些内存开销，因此使用非捕获组会(稍微)减少模式使用的内存。

## 总结

正则表达式中的子模式组对于分割字符串的一部分非常方便，对于替换和重新格式化字符串非常有用。您应该为需要的组命名，并为需要处理但代码不需要的组设置非捕获选项。