# 第 6 章测试您的外接程序

一旦编写了外接程序，就可以使用 Visual Studio 调试器轻松地对其进行测试。但是，一旦您查看了 XML 配置文件并了解了外接程序的生命周期，调试就会变得容易一些。

## 配置文件

当您第一次使用向导创建外接程序时，向导会生成您的类代码，以及控制外接程序行为的两个 XML 配置文件。这些是:

*   <add-in name="">-用于测试。Addin</add-in>
*   <add-in name="">addin</add-in>

### 用于测试。AddIn

当您使用向导生成外接程序时，它会创建 XML 文件并将其放入外接程序文件夹中。此文件允许 Visual Studio 加载外接程序，但引用项目文件夹中的程序集 DLL。除了程序集位置之外，该文件的内容与您将用来安装外接程序的实际 AddIn 文件的内容相同。

当然，这可以为将来的调试会话创建一个 catch-22。当 Visual Studio 加载外接程序时，包含外接程序代码的 DLL 会被 IDE 锁定。因此，当您尝试调整和构建外接程序时，可能会看到以下消息:

无法删除文件”。\bin\CodeWindow.dll "。

对路径“C:\ user \..' documents \ visual studio 2010 \ Projects \ CodeWindow \ CodeWindow \ bin \ CodeWindow . dll '被拒绝。

### 插件设置

外接程序配置文件包含一些控制加载外接程序的方式和时间的设置。这些设置可以在 XML 文件的<addin>元素中找到。</addin>

### 负载行为

该值指示加载外接程序的时间。可用的值有:

*   0:必须手动加载外接程序。
*   1:当 IDE 启动时，外接程序会自动加载。
*   4:从命令提示符启动时加载外接程序。

您很少会看到选项 4，因为大多数外接程序都提供用户界面，从命令行运行时没有意义。选项 0 有利于调试，因为加载项的 DLL 只在您打开加载项时加载，而不是每次打开 IDE 时都加载。

### 突击搜查

此值确定加载项是通过加载项管理器加载，还是在 Visual Studio 启动时自动加载(加载项文件安装后的第一次加载):

*   0:外接程序必须由外接程序管理器手动启动。
*   1:安装后 Visual Studio 启动时首次加载外接程序。

有时，当您调试一个外接程序时，您可能需要在外接程序文件中将**命令预加载**设置为 **0** ，以允许您在编译外接程序时更新 DLL。如果您将其设置为 **1** ，当您尝试重建加载项文件时，可能会出现“无法删除”的错误。

我建议在启动时不加载外接程序的情况下生成外接程序向导，以便于测试和调试。准备好部署外接程序后，如果希望在启动时加载外接程序，可以手动将**加载行为**标志更改为 **1** 。

## 插件生命周期

**加载行为**设置控制调用连接类中的哪些事件以及何时调用。无论设置如何，前两个事件总是:

*   使用 cm_UISetup 连接模式连接。
*   使用 dm_UISetup 断开模式断开连接。

这就是为什么当您在 CM_UISetup 模式期间将外接程序模块附加到 Visual Studio 时，它总是被调用。

### 0:手动调用

当设置为手动调用时，加载项不会被再次调用，直到您从菜单中实际请求它。该命令已添加到集成开发环境中，菜单已更新，但代码未加载。从菜单或工具栏中选择项目后，将调用“启动后连接 cm”。

此时，外接程序被加载到内存中。您可以使用加载项管理器手动卸载它，在这种情况下，将调用与 dm _ userShutdown 断开连接。如果不手动关闭它，将调用带有 dm_HostShutdown 和 Disconnect–的事件。如果您已经手动关闭它，这些事件将不会被调用，因为加载项不再在内存中。

如果您计划手动加载外接程序，请确保在断开连接方法期间设置任何要保存的配置信息。

### 1:启动时的负载

当设置为在启动时加载时，会触发其他事件，因为集成开发环境将加载您的外接程序作为启动代码的一部分:

*   与 cm_Startup 连接。
*   外接程序更新事件。
*   启动完成事件。

这意味着一旦集成开发环境出现，您的外接程序模块就会加载到内存中。除非您使用外接程序管理器手动卸载它，否则当用户关闭 Visual Studio 时，将触发以下事件:

*   开始关机。
*   断开与 dm _ 关机的连接。

您的外接程序将响应的事件的处理方式不同。在调试会话期间，我通常只在从菜单调用时加载外接程序。但是，一旦代码准备好部署，我通常会将标志设置为 **1** ，在启动时加载。

## 调试

通过按 F5 调试外接程序时，将加载 Visual Studio 的第二个实例。当此实例加载时，它将看到新添加的 XML 文件，并将外接程序模块加载到 Visual Studio 中。此时，您可以单步执行外接程序并调试代码，也可以运行它并测试其行为。

## 常见错误

以下是使用外接程序时可能会出现的一些常见错误。

### 菜单上未启用加载项

如果菜单上没有您的加载项，请检查**查询状态**方法，并确保返回状态变量包含**命令支持的**和**命令启用的**。

### 从未调用过加载项

如果 exec 命令中的命令名称与外接程序类名称和外接程序 XML 文件中的友好名称不匹配，您的 Exec 方法将永远不会到达您的代码。

### 未触发的事件

确保您期望调用的事件与 XML 文件中设置的**加载行为**模式兼容。

### 看不到代码变化

有时，您的外接程序代码似乎无法识别最近的代码更改。如果是这种情况，最有可能的原因是加载了错误的 DLL 版本。我建议确保**加载行为**标志设置为 **0** ，重新启动 IDE，并从菜单中运行插件。这将加载 DLL 的最新版本。

## 移除插件模块

有时您可能需要完全删除一个外接程序模块。最简单的方法是在**加载项**和**宏**属性中指定的任何路径中找到并删除(或重命名)加载项 XML 文件。在**工具**菜单中，选择**选项**，然后选择**环境**。

## 讨厌的“无法删除”消息

有时，无论您重新启动 IDE 并调整设置多少次，您都可能无法摆脱“无法删除”的消息。如果您的外接程序在启动时未标记为加载，则不应加载该 DLL。但是如果无法卸载，可以用 **/SafeMode** 开关启动 IDE，加载 Visual Studio 时完全没有任何插件模块。

即使您在**安全模式**下启动 IDE，您仍然可以进行调试，因为 IDE 的第二个实例将在常规模式下启动，而无需应用**/安全模式**开关。如果您在使用外接程序时遇到问题，请考虑在桌面上创建一个免费的外接程序快捷方式，以便使用外接程序运行 IDE。