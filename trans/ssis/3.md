# 第三章控制流程

## 介绍

本章将解释如何在集成服务包中使用控制流。讨论的主题将基于它们的主要组件:任务、连接管理器、事件处理程序和容器。

在[架构章节](1.html#_Integration_Services_Architecture)中，我解释了包只能包含一个控制流，所以让我们学习如何开发一个。首先向项目中添加一个新包，然后在 SSIS 设计器中打开“控制流”选项卡。当“控制流”选项卡处于活动状态时，SSIS 工具箱会列出您可以添加到其中的任务和容器。下图显示了“控制流”选项卡在包设计器中的位置。

![](../Images/image024.jpg)

图 22:控制流选项卡

在集成服务设计器中构建控制流很容易；您只需要访问“控制流”选项卡，然后将所需的所有任务从 SSIS 工具箱拖放到“控制流”设计窗格中。将任务添加到设计窗口后，可以双击该任务以在其属性中指定其行为。正如我已经提到的，控制流是包执行的协调者。因此，在处理这个流程时，您应该考虑您希望您的包做什么——在每个任务中定义“如何”。

配置任务后，可以使用优先约束将其链接到其他任务。一旦你点击一个任务，你会注意到一个绿色的箭头从它指向下。如果将此箭头拖放到另一个任务中，您将创建所谓的“成功”约束。很简单，这些优先约束将各个可执行文件链接在一起，并决定工作流如何从一个可执行文件移动到下一个可执行文件。本主题将在[优先约束](#_Precedence_Constraints_1)一节中详细解释。

下图显示了使用这些优先约束连接的三个任务；例如，在一个场景中，如果 SQL 任务的执行成功或失败，您希望发送不同的电子邮件。在这种情况下，所使用的优先约束是不同的(OnSucess 和 OnFail)。

![](../Images/image025.jpg)

图 23:链接的任务

一旦使用这些优先约束连接了所有任务，并使用适当的向导配置了任务，就定义了包的控制流，并完成了包的执行工作流。看起来可能很简单；但是，每个任务都有自己的属性和配置。您可能会花费大量时间开发控制流执行所需的所有任务。

了解现有的任务是非常重要的，这样你就可以知道你需要用哪一个来应对特定的问题。因此，下一部分将向您展示集成服务 2012 开箱即用的所有任务。它将带您完成一些关于如何配置最常用任务的演示。(最常用的任务可能因开发人员而异；包含在下一部分中的那些是根据我的经验选择的)。

## 任务和容器

### 简介

任务是控制流中的原子或单个工作组件。它们允许您在包中执行特定的作业。包控制流中的任务总数定义了其执行的编排。将这些任务与编程语言进行比较，您可以将它们视为函数，即更改或获取对象状态的特定代码块。但是，在集成服务设计器中，您不需要编写任何代码；您只需将任务拖放到设计图面中，并使用它们的配置向导进行配置。

集成服务在其工具箱中提供了几个内置任务。要访问它们，请在包设计器中选择**控制流**选项卡，并从可用选项卡中进行选择。您将发现四个不同的组:收藏夹、常用、容器和其他任务。扩展这些组将允许您查看和使用它们的任务。

![](../Images/image026.jpg)

图 24: SSIS 工具箱任务

如果你不知道哪些任务存在，它们做什么，选择正确的任务并不容易。在本章中，我将解释 SSIS 工具箱中所有可用的任务。之后，我将演示如何使用这些任务。

### 最喜欢的任务

这是您个人的、可自定义的控制流任务工具箱组。默认情况下，它包含两个最常用的任务。第一个是数据流任务，它将源处理到目标，并检索、转换和插入到数据库或文件中。第二个是执行 SQL 任务，它允许您对关系数据库运行 DML(操作)、DDL(定义)和 DCL(控制)命令。

您可以通过右键单击任务组并选择一个可用的移动选项来移动任务组，如下图所示。

![](../Images/image027.jpg)

图 25:移动任务组

下表列出了“收藏夹”组中可用的默认任务。

表 1:最喜欢的任务

| 图标 | 名字 | 描述 |
| --- | --- | --- |
| ![Control Flow Toolbox Icons:Icon_Data_Flow_Task.PNG](../Images/image028.png) | 数据流任务 | 此任务允许您在转换和清理时在源和目标之间移动数据。这是集成服务中最重要的任务之一，因为它负责 ETL 处理。这可能是包控制流中唯一的任务。 |
| ![Control Flow Toolbox Icons:Icon_Execute_T-SQL_Statement_Task.PNG](../Images/image029.png) | 执行 SQL 任务 | 此任务将运行 SQL 数据操作或数据定义脚本，或者允许您对关系数据库执行存储过程。他们可能正在创建一个新表，截断一个现有的表，或者您需要的任何其他操作。 |

### 普通

“常见任务”组包括集成服务项目中最常用的任务。下表解释了每个任务。

表 2:常见任务

| 图标 | 名字 | 描述 |
| --- | --- | --- |
| ![Control Flow Toolbox Icons:Icon_Analysis_Services_Processing_Task.PNG](../Images/image030.png) | 分析服务处理任务 | 此任务允许您处理 SQL Server Analysis Services 对象，如多维数据集、维度和挖掘模型。 |
| ![Control Flow Toolbox Icons:Icon_Bulk_Insert_Task.PNG](../Images/image031.png) | 批量插入任务 | 此任务允许您使用批量插入 SQL 命令将数据加载到表中。此命令通常用于更快地插入大量数据，因为它不允许在将数据插入数据库时进行转换；是直接插入的。 |
| ![Control Flow Toolbox Icons:Icon_Data_Profiling_Task.PNG](../Images/image032.png) | 数据分析任务 | 此任务允许您在管理数据之前或之后检查数据。此任务将分析和识别数据质量问题，如意外的空值。 |
| ![Control Flow Toolbox Icons:Icon_Execute_Package_Task.PNG](../Images/image033.png) | 执行包任务 | 此任务允许您从另一个包中执行一个包。这样，您可以在包之间共享包的逻辑，从而创建一个更容易维护的模块化结构。 |
| ![Control Flow Toolbox Icons:Icon_Execute_Process_Task.PNG](../Images/image034.png) | 执行流程任务 | 此任务将执行包外部的程序。您可以调用应用程序，如记事本或窗口计算器、批处理文件、命令行实用程序或第三方程序。 |
| ![Control Flow Toolbox Icons:Icon_Expression_Task.PNG](../Images/image035.png) | 表达式任务 | 此任务允许您在运行时将变量设置为表达式，例如 SQL Server 数据库表中的当前记录数。 |
| ![Control Flow Toolbox Icons:Icon_File_System_Task.PNG](../Images/image036.png) | 文件系统任务 | 此任务允许您与文件系统进行交互。您可以执行创建文件夹、重命名或删除目录等操作，甚至可以对文件执行相同的操作。例如，您可以使用它来创建日志文件夹。 |
| ![Control Flow Toolbox Icons:Icon_FTP_Task.PNG](../Images/image037.png) | 文件传输协议任务 | 此任务允许您管理目录以及从 FTP 服务器发送或接收文件。例如，您可以将文件从远程 FTP 服务器加载到数据流中，或将平面文件传输到远程 FTP 服务器。 |
| ![Control Flow Toolbox Icons:Icon_Script_Task.PNG](../Images/image038.png) | 编写任务脚本 | 此任务允许您执行标准 SSIS 任务没有提供的功能。例如，您可以调用外部应用编程接口作为控制流的一部分。例如，想象一下，调用一个社交网络应用编程接口并从中检索数据，将其添加到您的数据流中。 |
| ![Control Flow Toolbox Icons:Icon_Send_Email_Task.PNG](../Images/image039.png) | sendmail 任务 | 此任务允许您使用 SMTP 协议发送电子邮件。您可以使用它通过电子邮件通知 ETL 过程的成功或失败。 |
| ![Control Flow Toolbox Icons:Icon_Web_Service_Task.PNG](../Images/image040.png) | 网络服务任务 | 此任务允许您在 Web 服务上运行方法，并将返回分配给变量或文件。例如，您可以获取每天的天气温度或风速，然后将返回值赋给一个变量。 |
| ![Control Flow Toolbox Icons:Icon_XML_Task.PNG](../Images/image041.png) | 可扩展标记语言任务 | 此任务允许您处理 XML 数据。此任务的常见操作是检索 XML 文档、使用 XPath 表达式以及合并多个文档。您还可以验证、比较和保存更新的文档到文件或变量中。 |

### 容器

容器不是任务；它们用于将任务逻辑地组合成独特的工作单元。这样，您可以根据流程逻辑将几个任务视为一个。使用容器对相关的工作单元任务进行分组有几个优点。优点之一是能够在容器级别定义变量和事件处理程序的范围，或者更好的是，能够迭代重新定义的枚举，直到条件得到验证。有四种类型的容器:

*   任务主机容器
*   对于循环容器
*   Foreach 循环容器
*   序列容器

您可以在 SSIS 工具箱的“容器”组中找到容器。下表解释了四个容器中的每一个。

表 3:容器

| 形状 | 名字 | 描述 |
| --- | --- | --- |
| 不适用的 | 任务主机容器 | 这不是一个可用的容器。每次向控制流中添加任务时，都会封装一个任务。这意味着每次向控制流添加任务时，都是在创建一个新的容器。 |
| ![Control Flow Toolbox Icons:Icon_For_Loop_Container.PNG](../Images/image042.png) | 对于循环容器 | 该容器允许您迭代一系列任务，直到满足某个条件。在这种情况下，可以使用容器变量来定义要计算的表达式。例如，您可以使用它来加载目录中的文件子集，或者为日期之间的每一天执行数据流。在这种情况下，您可以根据日期定义条件。 |
| ![Control Flow Toolbox Icons:Icon_Foreach_Loop_Container.PNG](../Images/image043.png) | Foreach 循环容器 | 这个容器允许你在一个有限的数据集中迭代一系列的文件或记录，然后在容器中为每个元素执行任务。您可以将其用于与 for 循环容器相同的目的；不同的是，这个不会使用条件来停止迭代，而是使用数据集的最后一个元素。这样，您不需要任何表达式，只需要一个数据集。 |
| ![Control Flow Toolbox Icons:Icon_Sequence_Container.PNG](../Images/image044.png) | 序列容器 | 该容器允许您逻辑地组织与区域相关的任务。例如，这可以用于并行执行任务序列。如果您有包含大量任务的大型控制流，这是一个有用的工具，因为这些容器有一个折叠和扩展机制来更好地组织您的流。 |

### 其他任务

“其他任务”组包括集成服务项目中不常使用的任务。然而，它们和普通的一样重要，甚至比普通的更重要。如果您掌握了这些任务，您将能够在不编写一行代码的情况下对 SQL 数据库做几乎任何事情。下表解释了每个任务。

表 4:其他任务

| 形状 | 名字 | 描述 |
| --- | --- | --- |
| ![Control Flow Toolbox Icons:Icon_Analysis_Services_Execute_DDL_Task.PNG](../Images/image045.png) | 分析服务执行分布式拒绝服务任务 | 此任务允许您在 SQL Server Analysis Services 中执行 DDL 操作，例如创建、删除或更改多维数据集。 |
| ![Control Flow Toolbox Icons:Icon_Back_Up_Database_Task.PNG](../Images/image046.png) | 备份数据库任务 | 此任务允许您指定源数据库、目标文件或磁带以及覆盖选项，以便在数据库上运行备份操作。 |
| ![Control Flow Toolbox Icons:Icon_CDC_Control_Task.PNG](../Images/image047.png) | 疾控中心控制任务 | 此任务允许您维护 SQL Server 的变更数据捕获(CDC)功能并与之交互。您可以使用它来控制变更数据处理包的生命周期。 |
| ![Control Flow Toolbox Icons:Icon_Check_Database_Integrity_Task.PNG](../Images/image048.png) | 检查数据库完整性任务 | 此任务允许您对数据库中的数据和索引页执行内部一致性检查。 |
| ![Control Flow Toolbox Icons:Icon_Data_Mining_Query_Task.PNG](../Images/image049.png) | 数据挖掘查询任务 | 此任务允许您对分析服务数据挖掘模型运行预测查询。 |
| ![Control Flow Toolbox Icons:Icon_Execute_SQL_Server_Agent_Job_Task.PNG](../Images/image050.png) | 执行 SQL Server 代理作业任务 | 此任务允许您选择要作为维护计划的一部分运行的 SQL Server 代理作业。 |
| ![Control Flow Toolbox Icons:Icon_Execute_T-SQL_Statement_Task.PNG](../Images/image051.png) | 执行语句任务 | 此任务允许您对 SQL Server 数据库运行任何 Transact-SQL 查询。 |
| ![Control Flow Toolbox Icons:Icon_History_Cleanup_Task.PNG](../Images/image052.png) | 历史清理任务 | 此任务允许您删除与备份和恢复、SQL Server 代理以及维护计划操作相关的历史数据。用户界面允许您指定要删除的数据的类型和期限。 |
| ![Control Flow Toolbox Icons:Icon_Maintenance_Cleanup_Task.PNG](../Images/image053.png) | 维护清理任务 | 此任务允许您删除执行维护计划时留下的文件。 |
| ![Control Flow Toolbox Icons:Icon_Message_Queue_Task.PNG](../Images/image054.png) | 消息队列任务 | 此任务允许您从 Microsoft 消息队列(MSMQ)发送或接收消息。需要注意的一点是，队列必须在运行包的同一台计算机上。 |
| ![Control Flow Toolbox Icons:Icon_Notify_Operator_Task.PNG](../Images/image055.png) | 通知操作员任务 | 此任务允许您向任何 SQL Server 代理操作员发送电子邮件。 |
| ![Control Flow Toolbox Icons:Icon_Rebuild_Index_Task.PNG](../Images/image056.png) | 重建索引任务 | 此任务允许您重建索引以重新组织元数据和索引页。这提高了索引扫描和查找的性能。此任务还优化了索引页面上的数据和可用空间的分布，从而加快了未来的增长。 |
| ![Control Flow Toolbox Icons:Icon_Reorganize_Index_Task.PNG](../Images/image057.png) | 重组索引任务 | 此任务允许您对表和视图的聚集索引和非聚集索引进行碎片整理和压缩。 |
| ![Control Flow Toolbox Icons:Icon_Shrink_Database_Task.PNG](../Images/image058.png) | 收缩数据库任务 | 此任务允许您通过删除空数据和日志页来减少数据库和日志文件占用的磁盘空间。 |
| ![Control Flow Toolbox Icons:Icon_Transfer_Database_Task.PNG](../Images/image059.png) | 传输数据库任务 | 此任务允许您在两个 SQL Server 实例之间传输 SQL Server 数据库。它还可以用于复制同一服务器中的数据库。 |
| ![Control Flow Toolbox Icons:Icon_Transfer_Error_Messages_Task.PNG](../Images/image060.png) | 传输错误消息任务 | 此任务允许您在 SQL Server 实例之间传输 SQL Server 用户定义的错误消息。此任务可以配置为传输所有错误消息或仅传输指定的错误消息。用户定义消息的标识符等于或大于 50000。 |
| ![Control Flow Toolbox Icons:Icon_Transfer_Jobs_Task.PNG](../Images/image061.png) | 转移作业任务 | 此任务允许您在 SQL Server 实例之间传输 SQL 代理作业。您可以转移所有作业或仅转移选定的作业。 |
| ![Control Flow Toolbox Icons:Icon_Transfer_Master_Stored_Procedures_Task.PNG](../Images/image062.png) | 传输主存储过程任务 | 此任务允许您在 SQL Server 实例上的主数据库之间传输一个或多个用户定义的存储过程。 |
| ![Control Flow Toolbox Icons:Icon_Transfer_Logins_Task.PNG](../Images/image063.png) | 传输登录任务 | 此任务允许您在 SQL Server 实例之间传输一个或多个登录名。您可以传输所有登录信息，也可以只传输某些选定的登录信息。 |
| ![Control Flow Toolbox Icons:Icon_Transfer_SQL_Server_Objects_Task.PNG](../Images/image064.png) | 传输 SQL Server 对象任务 | 此任务允许您在 SQL Server 实例之间传输一种或多种类型的对象。 |
| ![Control Flow Toolbox Icons:Icon_Update_Statistics_Task.PNG](../Images/image065.png) | 更新统计任务 | 此任务允许您更新查询优化器，以获得表中数据值分布的最新信息。这将优化您的查询执行。 |
| ![Control Flow Toolbox Icons:Icon_WMI_Data_Reader_Task.PNG](../Images/image066.png) | WMI 数据阅读器任务 | 此任务允许您对 Windows 管理规范运行 WQL 查询。这使您能够读取事件日志，获取已安装的应用程序列表，或者确定已安装的硬件。 |
| ![Control Flow Toolbox Icons:WMI_Event_Watcher_Task.PNG](../Images/image067.png) | WMI 事件观察者任务 | 此任务允许您让 SSIS 等待并响应操作系统中发生的某些 WMI 事件。 |

## 优先约束

### 简介

集成服务控制流组件使用优先约束来定义每个任务和容器的执行顺序、管理包的工作流以及处理错误情况。有三种主要类型的优先约束，可以通过它们的颜色来定义:

*   `Blue`—定义任务或容器完成的优先约束；可以是成功也可以是失败。
*   `Green`-定义任务或容器成功的优先约束。
*   `Red`-定义任务或容器失败的优先约束。

![](../Images/image068.jpg)

图 26:可用的基本优先约束

这些约束的行为很容易理解。在成功的情况下，链接到当前正在执行的任务或容器只有在当前执行成功时才会运行。当处理失败约束时，行为正好相反:只有当前执行失败时，下一个任务或容器才会运行。当使用完成约束时，无论当前执行是否失败，都将执行下一个任务，这意味着无论如何，都将始终执行这个任务。

重要的是要记住，您可以为同一个任务或容器设置所有这三个。我举个例子。您可以定义在执行数据流任务后，您总是要执行一个 SQL 脚本，在失败时发送一封电子邮件，在成功时再运行四个数据流任务。

链接两个任务或容器时，默认的优先约束是绿色箭头，表示成功，因为它是最常用的。但是，您可以通过右键单击箭头并选择不同的评估来更改其行为。上图显示了使用所有优先约束链接任务的样子。下图显示了用于更改优先约束类型的菜单。

![](../Images/image069.jpg)

图 27:更改优先约束类型

### 高级优先约束

尽管评估任务或容器的成功或失败可能是控制包流的好机制，但在某些情况下，您可能需要更多的流执行控制。此类场景包括仅在特定日期或时间运行，甚至基于源表中特定数量的记录运行。为了满足这些要求，您可以编辑在优先约束中评估的条件。

要编辑优先约束内的条件，首先使用三个可用选项(绿色、红色或蓝色)链接任务或容器。接下来，双击链接它们的箭头以打开优先约束编辑器。下图显示了该编辑器的外观。

![](../Images/image070.jpg)

图 28:优先约束编辑器

通过使用优先约束编辑器，您不仅可以评估任务或容器执行的成功或失败。在不涉及太多细节的情况下，让我们简单看一下四个可用的选项。

从上图中可以看出，第一个选项“约束”是基本选项。当您需要三个基本可用约束之一(成功、失败或完成)时，可以使用它。然而，优先约束的灵活性伴随着其他选项。选项的完整列表解释如下。

*   约束-仅使用优先可执行文件的执行结果来确定受约束的可执行文件是否运行。优先可执行文件的执行结果可以是成功、失败或完成。这是默认操作。
*   表达式—评估表达式以确定受约束的可执行文件是否运行。如果表达式的计算结果为真，则受约束的可执行文件将运行。
*   表达式和约束-一个表达式和一个约束，它将优先可执行文件的执行结果的要求与计算表达式返回的结果相结合。
*   表达式或约束-使用优先可执行文件的执行结果或计算表达式返回的结果的表达式或约束。

还有一个有趣的概念，叫做多重约束，当一个任务有多个输入，并且彼此有不同的优先约束时，通常会用到这个概念。对约束进行分组使您能够在包中实现复杂的控制流；但是，您需要告诉 SSIS 如何管理所有优先约束的互操作性。

为此，您有两种选择:使用“与”逻辑运算符对它们进行分组，其中所有约束都必须计算为真；或者使用“或”逻辑运算符，其中一个优先约束必须计算为真。

如果选择约束以外的任何求值操作，集成服务将允许您在优先约束编辑器中打开表达式生成器，以便开发正在求值的表达式。下图显示了表达式生成器和要计算的示例表达式。在这个例子中，我使用一个预设变量来检查是否有要处理的记录。

![](../Images/image071.jpg)

图 29:表达式生成器

## 连接管理器

### 简介

连接管理器是允许您连接到第三方平台以便检索、插入或对其数据执行操作的组件。集成服务允许您指定两种类型的连接管理器:一种是在解决方案级别，另一种是在包级别。如果在包级别定义连接，则只有该特定包的控制流和数据流才能使用它。另一方面，如果您在解决方案级别定义它，那么该解决方案中所有包的所有控制流和数据流都将能够使用它们。下图显示了“添加 SSIS 连接管理器”窗口。

![Macintosh HD:Users:ruimachado:Desktop:Captura de ecrã 2014-02-9, às 12.39.35.png](../Images/image072.jpg)

图 30:可用的连接管理器

### 在解决方案级别添加连接管理器

要在解决方案级别配置连接管理器，应该在解决方案资源管理器中进行配置。右键单击**连接管理器**部分，选择**新建连接管理器**。下图显示了该选项的外观。

![Macintosh HD:Users:ruimachado:Desktop:Captura de ecrã 2014-02-9, às 12.24.21.png](../Images/image073.jpg)

图 31:创建解决方案级连接

### 在包级别添加连接管理器

要在包级别配置连接管理器，您应该使用包底部的连接管理器窗格。要创建新连接，右键单击**连接管理器**窗格。对于此连接管理器，您有几个选项。要使用默认连接管理器，选择**新连接**。如果您喜欢使用任何连接类型的快捷方式，如 OLE 数据库、平面文件、ADO.NET、分析服务或文件，您可以从这里直接选择它们。下图显示了右键单击“连接管理器”窗格后显示的菜单。

![Macintosh HD:Users:ruimachado:Desktop:Captura de ecrã 2014-02-9, às 12.27.50.png](../Images/image074.jpg)

图 32:创建包级连接

### 可用的连接管理器

集成服务中有几个可用的连接管理器，用于连接到 Excel 文件、SQL Server 数据库、FTP 客户端等。在本章中，我将解释如何使用一些最常用的连接类型，以及如何配置它们，以便您可以成功地创建到源或目标的连接。可用连接类型的完整列表如下:

*   麻烦
*   ADO.NET
*   隐藏物
*   DQS 服务器
*   擅长
*   文件
*   扁锉
*   文件传送协议
*   超文本传送协议
*   MSMQ(消息队列)
*   分析服务
*   多文件(多个文件)
*   多平面文件(多平面文件)
*   开放式数据库连接性
*   **OLE 数据库(SQL Server)**
*   高年资军医(senior medical officer)
*   简单邮件传输协议
*   SQL Mobile
*   WMI

粗体强调的 OLE 数据库(SQL Server)是我将解释如何使用的数据库。所有连接管理器的工作方式都类似，因为它们是向导，可以帮助您更快、更安全地配置连接，从而避免错误。

### 创建新的 OLE 数据库(SQL 服务器连接)

在本演示中，我们将使用 OLE 数据库连接管理器创建到 SQL Server 2012 数据库的新连接。要开始操作，请按照前面提供的说明在项目级别添加新的连接管理器。

连接管理器向导打开后，选择 **OLEDB** 类型，点击**添加**按钮开始，如下图所示。

![](../Images/image075.jpg)

图 33:选择 OLE 数据库连接管理器

OLE 数据库连接管理器向导将打开。此时，您需要知道您的服务器名称以及您想要访问的数据库。还要记住，现在应该在数据库中配置用于连接数据库的用户名。

集成服务存储以前项目中配置的以前的连接。这样，当您打开向导时，如果您已经配置了任何 OLE DB 连接类型，您将在向导中看到它，如下图所示。如果您需要的连接已经配置，您可以直接选择它。例如，让我们单击**新建**从头开始配置新连接。

![](../Images/image076.jpg)

图 34:以前的连接

现在让我们开始配置到我们的 SQL Server 数据库的连接。一旦新连接向导启动，您需要提供我之前提到的所有属性来建立连接。如下图所示，提供所有必填字段后，点击左下角**测试连接**即可测试连接。

![](../Images/image077.png)

图 35:配置连接

创建成功连接后，在当前屏幕中点击**确定**，然后在连接管理器屏幕中点击**确定**完成配置。现在，您将能够在解决方案资源管理器内的“连接管理器”文件夹中看到您的新连接。

![](../Images/image078.png)

图 36:创建的新连接

### 修复:64 位环境下运行包时 Excel/Access 连接管理器错误

虽然我没有做过 Excel 或 Access 连接管理器的演示，但我想对这两个连接管理器的使用做一个特别的说明，因为它们与 64 位环境不兼容，但有一种方法可以解决这个问题。

该问题仅在 64 位环境中出现，因为 Excel 和 Access 连接管理器与它们不兼容。这可能是集成项目中的一个问题；许多都有一个初始加载阶段，在这个阶段，我们从几个 Excel 文件中获取数据，并将它们集成到一个 SQL Server 数据库中。

例如，假设您在 64 位环境中安装了具有商业智能功能的 SQL Server 2012 但是，您希望在数据流中使用 Excel 源。

![](../Images/image079.png)

图 37:简单包

当您编译并运行这样的包时，默认情况下，SSIS 会尝试在 64 位版本中执行它。您将得到以下错误:

`[Read from source [16]] Error: SSIS Error Code DTS_E_CANNOTACQUIRECONNECTIONFROMCONNECTIONMANAGER. The AcquireConnection method call to the connection manager “YOUR CONNECTION NAME” failed with error code 0xC0209303\. There may be error messages posted before this with more information on why the AcquireConnection method call failed.`

出现此错误是因为 SSIS 引擎将尝试在 64 位版本中运行该包，并且 Excel 连接管理器仅与 32 位包兼容。解决这个问题很容易。在解决方案资源管理器中右键单击项目，打开包的属性，如下图所示。

![](../Images/image080.png)

图 38:打开属性窗口

接下来，展开**配置属性**并打开**调试**选项。一旦它们打开，将 **Run64BitRuntime** 属性更改为 **False** 以强制项目包以 32 位运行。配置属性现在应该如下图所示。

![](../Images/image081.png)

图 39:更改属性以运行 32 位包

虽然这个解决方案不会干扰项目中的任何其他连接管理器，但是您必须知道，这个项目中的所有包现在都将以 32 位运行。

## 事件处理程序

### 简介

事件处理程序允许您捕获和处理使用集成服务执行对象时引发的事件。在定义了要捕获的事件之后，SSIS 允许您开发在检测到事件时要执行的数据流。为了防止包的执行失败和 ETL 过程的停止，了解您能够捕获的事件是非常重要的。

为了更好地管理包中的事件处理程序配置，SSIS 在包设计器中提供了一个特定的选项卡。要访问它，选择**事件处理程序**选项卡，如下图所示。

![Event Handler.png](../Images/image082.jpg)

图 40:事件处理程序

从上图中可以看到，这个事件处理程序选项卡中有两个下拉菜单。第一个下拉菜单“可执行”允许您选择与事件处理程序关联的包中的任务或容器(您也可以在当前包级别定义它)。第二个下拉菜单“事件处理程序”允许您选择要捕获的事件。

### 使用事件处理程序

在本节中，我将展示如何在使用集成服务开发包时使用事件处理程序。第一步是打开要在其中配置事件处理程序的包。打开后，在包设计器中选择**事件处理程序**选项卡。

在事件处理程序窗口中，在左侧组合框中选择要添加事件处理程序的可执行文件，并在右侧组合框中选择要添加的事件，如下图所示。

![](../Images/image083.jpg)

图 41:创建事件处理程序

映射可执行文件和事件处理程序后，选择窗口底部的超链接，如下图所示。这将打开一个新的事件处理程序设计窗口。

![](../Images/image084.jpg)

图 42:打开事件处理程序设计器

在事件处理程序设计器中，您可以设计一个正常的控制流，以便在捕获到此错误时编排执行流。在这个例子中，我向我们的 ETL 开发人员发送了一封电子邮件，并将错误保存到一个 XML 文件中。完成开发后，保存包并进行测试。

![](../Images/image085.jpg)

图 43:一个错误事件处理程序

## 故障排除

故障排除在每项技术中都很重要。您可以在使用编程语言和数据库时进行操作。集成服务也不例外。处理包执行中的错误的第一步是正确使用优先约束和事件处理程序。

然而，这两种机制不足以识别和解决包执行中的问题。有时，您需要设置断点或将错误记录到预定义的数据库中，以便评估变量值，记录值，并在记录的值不是预期值时采取必要的措施来修复它。

### 断点

让我们从分析断点开始。SSIS 为您带来了自己的断点，以便您可以在特定的步骤停止包的执行，并评估变量和其他组件的状态。他们工作起来就像在任何其他编程语言中一样；如果您使用过 Visual Studio 进行任何语言的编程，那么您对断点机制都很熟悉。主要区别在于，在这些情况下，您通过代码行定义它们，而在 SSIS，您在任务、容器或包中定义它们。如您所见，它们在数据流中不可用。

要定义断点，只需右键点击想要的组件，选择**编辑断点**。这将打开**设置断点**窗口，您将在其中开发断点。

![](../Images/image086.jpg)

图 44:编辑断点

同样，如果你熟悉编程语言 IDEs 中的断点，在 SSIS，这个概念是不同的。您不会单击您希望停止执行的行，而是启用基于事件的中断条件。下图显示了断点编辑器的外观。

![](../Images/image087.jpg)

图 45:断点编辑器

### 使用断点在执行任务前停止

在本例中，我将向您展示如何在包执行特定任务之前使用断点来停止包的执行。在本例中，我们将在执行 SQL 任务之前停止。第一步是打开断点编辑器，选择 **OnPreExecute** 事件，如下图所示。

![](../Images/image088.jpg)

图 46:启动紧急事件

添加断点后，您希望保存并关闭断点编辑器。一旦这样做了，所有添加了断点的可执行文件都将被标记为红点，如下图所示。

![](../Images/image089.jpg)

图 47:带有断点的任务

定义了这些断点后，当您运行可执行文件时，引擎将在这些断点处停止；然后，您可以在执行的这个阶段检查变量和参数。

### 测井

同样，在任何编程语言或信息系统平台中，日志对于理解错误、执行时间和更多的信息是必不可少的，而不必调试解决方案。在 SSIS，日志机制非常容易使用和理解。只需选择几个复选框并配置一些组件，您就可以开始以 XML 或 SQL Server 表记录您的 ETL 过程执行。这是因为它有一组内置的功能，可以捕获关于包执行的细节。

记录信息时，您有几个输出对象选项。您可以生成文本文件、XML 文件、登录到 SQL Server 数据库，甚至生成一个 Windows 事件。为了向您展示激活日志记录有多简单，在下一节中，我将创建一个演示，用您的包执行日志创建 XML 文件。

### 激活登录您的包

需要注意的一点是，如果项目将存储在 SSISDB 目录中，则不需要激活 SSIS 日志记录。要激活包中的记录机制，单击工具栏中的 **SSIS** ，选择**记录**。这将打开日志配置编辑器。

![](../Images/image090.jpg)

图 48:打开日志菜单

编辑器打开后，您需要在左侧的**容器**窗格中指定要激活登录的包。在本例中，我为控制流中的三个任务的事件处理程序启用了日志记录。之后，我们需要选择要存储日志的提供商。在这个例子中，我将日志保存到一个文件中。选择提供商很简单，只需从**提供商类型**组合框中选择一个，然后点击**添加**。

![](../Images/image091.jpg)

图 49:日志配置编辑器

在选定的可执行文件中配置日志记录的下一步是定义要将日志存储到其中的提供程序。在这种情况下，我们选择了一个文本提供程序，我们需要配置一个新的文件来连接，它告诉提供程序它应该在哪里存储日志。不要忘记使用左侧的复选框来启用提供程序。这允许您轻松启用和禁用您的提供程序。

![](../Images/image092.jpg)

图 50:配置提供者

正如我之前提到的，我们需要定义存储日志的文件。下图显示了我们将在其中定义它的文件连接属性窗口。

![](../Images/image093.jpg)

图 51:文件连接管理器编辑器

最后但并非最不重要的一点是，我们需要启用我们希望与此日志配置相关联的事件。为此，单击**详细信息**选项卡并启用您想要的选项。在这种情况下，我已经启用了所有这些功能。

![](../Images/image094.jpg)

图 52:启用事件日志记录

保存并关闭窗口后，您现在可以测试这个日志机制。为此，运行包并打开日志文件。如果一切顺利，您的文件应该如下图所示。

![](../Images/image095.jpg)

图 53:记录结果

## 创建简单的控制流

若要使用控制流任务，请将其拖放到设计窗口中。对于本例，新增**执行 SQL 任务**，如下图所示。

![](../Images/image096.png)

图 54:执行 SQL 任务

接下来，将此任务重命名为“创建临时表”，然后双击它以打开配置窗口。下图显示了此测试任务类型的配置窗口。

![](../Images/image097.jpg)

图 55:执行 SQL 任务编辑器

要使这个任务工作，您只需要配置两个属性:连接和 SQL 语句。在连接中，您需要配置将在其中执行该 SQL 语句的 SQL 数据库。此语句是 DDL、DML 或 DCL 语句。

在这个例子中，我们的控制流将使用我们刚刚配置的执行 SQL 任务创建一个新的临时表，然后执行一个简单的数据流任务。因此，为了创建临时表，我们在任务中设置了 SQL 语句，如下面的代码示例所示。

```
    CREATE TABLE [dbo].[STG_FOOT_STAT_TB](
           [Season] [varchar](9) NOT NULL,
           [Date] [datetime] NULL,
           [HomeTeam] [nvarchar](255) NULL,
           [AwayTeam] [nvarchar](255) NULL,
           [FTHG] [float] NULL,
           [FTAG] [float] NULL,
           [FTR] [nvarchar](255) NULL,
           [Referee] [nvarchar](255) NULL,
           [HS] [float] NULL,
           [AS] [float] NULL,
           [HC] [float] NULL,
           [AC] [float] NULL,
           [HF] [float] NULL,
           [HO] [float] NULL,
           [AO] [float] NULL,
           [HY] [float] NULL,
           [AY] [float] NULL,
           [HR] [float] NULL,
           [AR] [float] NULL
    ) ON [PRIMARY]

```

下一步是将数据流任务添加到包控制流，并使用优先约束将前一个执行 SQL 任务连接到它。添加数据流任务时，不进行配置；相反，当您双击它时，SSIS 会将您带到数据流设计器，这样您就可以根据您的要求开发它。最终的简单控制流程如下图所示。

![](../Images/image098.jpg)

图 56:简单控制流程

| ![](../Images/note.png) | 注意:这只是一个如何创建控制流的简单示例。在您自己的开发中，您需要了解和理解所有现有的任务，并知道如何组合它们，以便满足您的项目需求。数据流开发将在下一章中详细介绍。 |