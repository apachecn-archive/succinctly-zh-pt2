# 第三章发展维度

在本章中，我解释了在为分析服务数据库开发维度的过程中要执行的开发任务。首先使用维度向导构建维度，然后配置控制维度内容和行为的属性属性。您还可以创建层次结构，以便于深入查看和优化多维数据集中的性能。如果需要在多维数据集中支持多种语言，可以为维度配置翻译。当您工作时，您可能需要解决最佳实践警告，以帮助您避免设计和性能问题。

## 维度向导

您可以使用维度向导选择用作维度源的表，并为维度和属性设置一些初始属性。要启动向导，右键单击解决方案资源管理器中的**尺寸**文件夹。在向导的**选择创建方法**页面上，保留默认选择**使用现有表格**。当您没有现有的表并且想要生成与特定设计相对应的表时，可以使用其他选项。

| ![](../Images/note.png) | 注意:例外情况是“在服务器上生成时间表”选项，该选项仅在分析服务数据库中创建和填充维度对象，而不在数据源中创建相应的表。 |

在向导的**指定源信息**页面，如图 12 所示，从 DSV 中选择相关表格，并至少标识关键列。键列唯一标识维度表中的每条记录，当您对源数据使用星型架构时，它通常是表的主键。如果表具有唯一标识记录所需的复合键结构，则可以将多个列指定为键列。

![](../Images/image013.jpg)

图 12:维度向导的指定源信息页面

在维度向导中，选择名称列是可选的。其目的是在浏览多维数据集或其元数据时显示维度成员的标签。如果不选择名称列，将显示键列中的值。

在维度向导的**选择维度属性**页面，如图 13 所示，选择要包含在维度中的*属性*。每个属性对应于 DSV 的一个表列。如果您忽略了重命名 DSV 中的列，也可以在此页面上重命名属性。

![](../Images/image014.jpg)

图 13:维度向导的选择维度属性页面

此页面上的另一项任务是指定用户在浏览多维数据集时是否可以独立查看每个属性。您可以通过在**启用浏览**列中保留默认选择来实现。例如，如果您有一个专门用于排序目的的属性，您可以清除该属性的**启用浏览**复选框。

| ![](../Images/note.png) | 注意:您也可以在维度向导的“选择维度属性”页上设置属性类型，但是您可能会发现使用维度设计器中可访问的商业智能向导更容易执行此任务。 |

## 维度设计器

完成维度向导后，**维度设计器**为新创建的维度打开，如图 14 所示。屏幕左侧是**属性**窗格，您可以在其中看到维度及其属性的树形视图。在树的顶部，一个带有三个箭头的图标从一个公共点放射出来，标识维度节点。该节点下面是与维度向导中的选择相对应的几个属性。当您在此树状视图中选择一个对象时，所选对象的相关属性会显示在出现在屏幕右下角的**属性**窗口中。微调维度设计的大部分工作包括配置维度及其属性的属性。

![](../Images/image015.jpg)

图 14:维度设计器

属性窗格的右侧是**层次结构**窗格。它最初总是空的，因为您必须手动添加每个层次结构，这将在本章后面解释。您添加的层次结构称为用户定义的层次结构，以区别于属性层次结构。用户定义的层次结构可以有多个级别，有助于帮助用户从汇总信息导航到详细信息。相比之下，每个属性层次结构只包含一个“全部”级别和一个叶级别。浏览多维数据集中的数据时，这些级别用于简单分组。

维度设计器中的第三个窗格是**数据源视图**窗格。在这里，您可以看到数据源视图的一个子集，仅显示用于创建维度的一个或多个表。

| ![](../Images/tip.png) | 提示:如果以后决定向维度添加更多属性，可以将每个属性从“数据源视图”窗格拖到“属性”窗格中，以将其添加到维度。 |

右上角的**解决方案资源管理器**始终显示项目中的文件。完成维度向导后，带有 DIM 扩展名的新文件将添加到项目中。如果以后关闭当前维度的维度设计器，可以在解决方案资源管理器中双击文件名将其重新打开。向项目中添加其他维时，每个维在“维”文件夹中都有自己的文件。

## 属性

属性始终与 DSV 中的一列或多列相关联。让我们仔细看看在**浏览器**中浏览一个属性意味着什么，这是 SSDT 维度设计器的第四个选项卡。在浏览维度的属性之前，必须先部署项目，将维度定义发送到分析服务服务器，并使用数据加载维度对象。为此，单击**构建**菜单上的**部署**。部署完成后，您可以在页面顶部的**层次**下拉列表中一次选择一个属性，然后展开 **All** 级别查看所选属性的内容，如图 15 所示。

![](../Images/image017.jpg)

图 15:维度设计器

该列表中所选属性的每个标签都是一个*成员*，包括列表顶部的**所有**成员。对于您在维度向导中指定的键列中的每个不同值，属性中都有一个成员，唯一的例外是**所有**成员。当用户浏览多维数据集时，分析服务使用 **All** 成员为成员提供总计或聚合值。

| ![](../Images/note.png) | 注意:列表中的成员数量(不包括“全部”成员)等于指定为属性的“键列”属性的列中的不同值的数量。列表中显示的标签由指定为属性的“名称列”属性的列设置。 |

### 属性属性

设置维度的大部分工作涉及配置属性属性。现在让我们仔细看看这个过程。

当您在**属性**窗格中选择一个属性时，您可以在**属性**窗口中查看其属性，如图 16 所示。在本例中，您可以看到**产品**属性的属性，该属性与 DSV 产品表中的主键列相关。这里有许多可配置的属性，但大多数用于性能优化、特殊情况设计或更改客户端工具中的浏览行为。您可以根据需要处理这些属性。对于开发的第一阶段，您应该关注那些您总是希望根据需要进行双重检查和重新配置的属性。具体来说，查看以下属性:**键列**、**名称列**、**名称**、 **OrderBy** 、**属性 hierarchy yenabled**和**用法**。

![](../Images/image018.jpg)

图 16:属性属性

使用维度向导创建维度时，**键列**和**名称列**属性在向导中为键属性设置，如本章前面所述。如果需要，可以使用多个键列来唯一标识属性成员，但只能指定一个名称列。如果需要使用多个列来提供名称，则必须返回 DSV，并通过创建命名计算或命名查询来连接那里的列，以生成具有所需值的单个列。

接下来应该检查属性的**名称**属性。它应该是一个用户友好的名称。也就是说，它应该是用户认可和理解的东西。它应该尽可能短，但仍然有意义。例如，您可以考虑将**产品的**维度的**名称**属性从**产品密钥**更改为**产品**，以缩短名称并消除用户的困惑。

您可能还需要更改成员的排序顺序。默认的排序顺序是按名称，这意味着您可以看到成员的字母列表。然而，有时你需要不同的顺序。例如，按字母顺序显示月份名称通常没有多大帮助。您可以按名称、键值甚至同一维度中的其他可用属性来排序属性成员列表。为此，您必须相应地调整 **OrderBy** 属性。如果选择按替代属性排序，还必须为 **OrderByAttribute** 属性指定一个值。

每当您有仅用于排序的属性时，您可能不希望它对用户可见。当您只想使用属性进行排序时，您可以通过将**属性层次启用**属性设置为**假**来完全禁用浏览。

**用法**是一个重要的属性属性，但可能不是你需要更改的属性，因为它通常会被自动正确检测。只有一个属性的**用法**值为**键**，该属性应该与 DSV 中被标识为主键的列相关联。否则，该属性的值应该是**常规的**，除非您使用的是父子层次结构，这一点我将在本章后面解释。

### 未知成员

有时，事实表的事务或事件数据的数据源在维度的某个外键列中包含空值或无效值。默认情况下，尝试处理与存在数据质量问题的事实表相关联的多维数据集会导致错误。但是，可能有一种业务案例，对于这种情况，最好使用缺少维度引用或维度引用无效的占位符来处理多维数据集。这样，就成功地处理了多维数据集，并且所有事实数据在多维数据集中都是可见的。为了适应这种情况，通过在**属性**窗格中选择维度(顶部节点)并将**未知成员**属性设置为**可见**来启用维度的未知成员，如图 17 所示。

![](../Images/image019.jpg)

图 17:未知成员属性

**未知成员**属性有四个可能的值:

*   **可见**。标记为“未知”的新成员将显示在每个属性的成员列表中。无效的事实记录不会导致多维数据集处理失败，事实记录的度量与未知成员相关联，如图 18 所示。

![](../Images/image020.jpg)

图 18:分配给可见未知成员的无效事实记录

| ![](../Images/note.png) | 注意:如果您决定将未知成员属性设置为可见，但希望使用不同的名称，请为维度设置未知成员名称属性。例如，您可以将未知成员名称属性设置为未知区域。因为它是维度属性，所以相同的名称会出现在维度中的每个属性和用户定义的层次结构中。 |
| ![](../Images/note.png) | 注意:如果维度键为空或无效，配置未知成员属性不足以忽略多维数据集处理期间的错误。有关管理错误处理选项的更多信息，请参见分析服务 2005 中[处理数据完整性问题的数据完整性控制部分。尽管此信息是为早期版本的分析服务编写的，但它仍然适用于以后的版本。](http://msdn.microsoft.com/en-us/library/ms345138.aspx) |

*   **隐藏**。使用此设置，无效的事实记录不会导致多维数据集进程失败。但是，尽管维度的总计正确显示了关联度量的聚合值，但在浏览多维数据集时，“未知”成员不会与其他成员一起出现。当可见成员的值与聚合值不匹配时，用户可能会感到困惑，如图 19 所示。

![](../Images/image021.jpg)

图 19:分配给隐藏的未知成员的无效事实记录

*   **无**。无效的事实记录导致多维数据集处理失败。必须解决该问题才能成功完成多维数据集处理。

![](../Images/image022.jpg)

图 20:无效事实记录导致的处理错误

*   **自动拉满**。此选项仅适用于 Analysis Services 2012 中的表格模式。

## 设计警告

通过查看和响应维度设计器和多维数据集设计器中显示的设计警告，可以避免分析服务中的常见问题。警告不会阻止维度或多维数据集的处理，但如果忽略，可能会导致性能不佳或用户体验不理想。当您在设计器中看到蓝色波浪下划线时，将指针悬停在下划线上以查看警告文本，如图 21 所示。

![](../Images/image023.jpg)

图 21:维度设计器的属性窗格中的设计警告

您必须执行的解决警告的步骤取决于具体的警告。不幸的是，SSDT 没有内置的指南来帮助你。但是，您可以参考 MSDN 的[设计警告规则](http://msdn.microsoft.com/en-us/library/bb630321(v=sql.105).aspx)来定位警告消息并查看相应的推荐。例如，为了解决图 21 中的警告，您添加了一个用户定义的层次结构，如本章下一节所述。有时，您实施的解决方案会产生新的警告。继续处理每个警告，直到所有警告都被清除。

| ![](../Images/note.png) | 注意:上一段中的设计警告规则链接特定于 SQL Server 2008 R2，但也适用于 SQL Server 2012 和 SQL Server 2008。 |

在某些情况下，您可能更愿意忽略警告。例如，根据“对于在用户定义的层次结构中用作级别的属性，避免可见的属性层次结构”警告，您可能会选择将对应于层次结构级别的属性保留在可见状态，而不是隐藏它们。您可以这样做，以便为用户在数据透视表中使用属性或用户定义的层次结构提供更大的灵活性，而不是将它们仅限制在用户定义的层次结构中(但只能在与用户一起查看选项之后)。在这种情况下，您可以选择以下选项之一:

*   **取消单个事件的警告**。在**错误列表**窗口中，如果不可见，可以从**查看**菜单打开，右键单击最佳实践警告，然后在子菜单上选择**消除**，如图 22 所示。在**消除警告**对话框中，您可以选择输入注释。消除警告后，蓝色波浪下划线消失。

![](../Images/image024.jpg)

图 22:消除维度的最佳实践警告

*   **针对所有事件全局消除警告**。在**数据库**菜单上，选择**编辑数据库**，然后点击数据库设计器的**警告**选项卡，如图 23 所示。在这里，您可以按类型查看警告(如尺寸设计)，清除警告左侧的复选框以将其全局消除，并可选择在**注释**列中键入解释。

![](../Images/image025.jpg)

图 23:全局和驳回的最佳实践警告

| ![](../Images/tip.png) | 提示:如果要启用以前已消除的实例警告，请在数据库设计器的“警告”页面底部的“已消除的警告”列表中选择它，然后单击“重新启用”。 |

## 用户定义的层次结构

用户总是可以在多维数据集浏览器中以他们喜欢的任何方式排列属性，但是添加用户定义的层次结构供他们使用通常是有帮助的。从不自动检测用户定义的层次结构；您必须手动添加它们。这种类型的层次结构称为用户定义的层次结构，因为作为分析服务开发人员，您是在定义层次结构，而不是在向维度添加属性时由分析服务自动生成属性层次结构。

要创建层次结构，请将属性拖到维度设计器的**层次结构**窗格中。添加每个属性时，将其放在现有级别的上方或下方，以实现所需的层次顺序，如图 24 所示。您还应该重命名层次结构，以提供更加用户友好的标签。

![](../Images/image026.png)

图 24:用户定义的层次结构

当用户在浏览器中选择一个层次结构时，用户可以轻松地从一个级别钻至下一个级别。例如，在 Excel 数据透视表中，用户可以在“类别”级别展开成员，以在“子类别”级别显示成员。然后，用户可以选择子类别级别的成员来查看产品级别的成员，如图 25 所示。

![](../Images/image027.jpg)

图 25:用户定义的层次结构中的成员

### 自然等级

向维度添加层次结构不仅有助于用户更有效地将数据从汇总数据导航到详细数据，而且当层次结构包含自上而下层次结构中每个级别之间的自然一对多关系时，例如“类别”、“子类别”和“产品”之间，还可以提高查询性能。这种结构通常被称为自然层次结构。

当级别之间存在自然的层次结构时，分析服务可以更有效地存储数据，还可以构建聚合来预先计算多维数据集中的数据。例如，当用户要求按类别销售时，服务器不必先扫描每笔交易，然后再按类别分组。相反，类别总计可以直接或间接获得，并且查询结果从分析服务返回的速度比要求分析服务根据事务级别的数据计算总和的速度快得多。我在第 4 章“开发立方体”中解释了更多关于聚合的内容

| ![](../Images/tip.png) | 提示:您可以决定允许用户从层次结构中独占访问属性。当属性中有大量成员时，例如客户，这尤其有用。在这种情况下，通常更可取的做法是要求用户从向数据透视表添加层次结构开始，然后向下筛选到更小的集合，例如特定城市的客户。为此，请为每个属性将 AttributeHierarchyVisible 属性设置为 false。该属性在用户定义的层次结构中可见，但不会作为独立的属性层次结构出现在维度的属性列表中。 |

### 非自然等级

您也可以在分析服务中创建非自然的层次结构。非自然层次结构的目的是提供属性的预定义分组。例如，在**产品**维度中，您可能有经常按颜色和尺寸分析产品销售的用户。您可以用颜色和大小属性建立一个层次结构，然后用户可以在浏览器中使用这个层次结构从颜色钻取到大小，如图 26 所示。在自然层次结构中，较低级别的成员只能与其父级别的一个成员相关联，但是在不自然的层次结构中，用户会看到像 L 和 M 这样的大小与多种颜色和白色相关联。

![](../Images/image028.jpg)

图 26:非自然层次结构

在不自然的层次结构中，没有查询性能的好处。这只是方便用户经常使用的常见分组，完全是可选的。

### 属性关系

当维度中有用户定义的层次结构时，正确定义属性关系非常重要。属性关系用于确保聚合高效工作，并且总计计算正确。当您第一次创建日期维中常见的层次结构时，层次结构的每个上层都与维的键属性有直接关系。您可以在维度设计器的属性关系选项卡上查看这些关系，如图 27 所示。

![](../Images/image029.png)

图 27:默认属性关系

在某些情况下，如果没有正确定义属性关系，可能会导致多维数据集中的总计计算不正确。然而，更大的风险是引入潜在的性能瓶颈。例如，假设聚合适用于**月**，但不适用于**季度**或**年**。当用户请求按季度销售时，分析服务必须使用事实表中的事务级别数据来按季度计算销售额。另一方面，如果属性之间存在适当的关系，分析服务会使用较低级别属性已经可用的值来计算较高级别属性的总计，并且通常会更快地计算这些值。即使没有聚合，查询性能也会受益于属性关系，因为它们有助于分析服务缩小为检索查询结果而必须扫描的多维数据集空间量。

若要更正维度设计器的“属性关系”选项卡上的属性关系，请将较低级别的属性拖到它上面一级的属性上。例如，将**月**拖至**季度**，然后将**季度**拖至**日历年**。通常，您不需要先删除错误的关系，但是如果需要，您可以选择代表两个属性之间关系的箭头，然后按 delete 键将其删除。图 28 显示了日期维度的一组正确定义的属性关系。

![](../Images/image030.jpg)

图 28:正确的属性关系

虽然数据源中的事实表存储了日期，但分析服务可以通过从左到右滚动或聚合属性关系链来计算月、季度或年。属性关系表示从左向右移动的多对一关系。换句话说，一个月有许多日期，一个季度有许多月份，一年有许多季度。

属性关系也可以有灵活或严格的关系类型，每种类型对维度处理都有不同的影响。默认情况下，属性关系类型是灵活的，如白色箭头所示。要更改关系类型，请右键单击两个属性之间的箭头，指向**关系类型**，并根据需要选择以下关系类型之一:

*   **灵活**。灵活的属性关系类型允许您通过将成员从一个父代重新分配给另一个父代来更新源维度表。例如，假设您决定将自行车类别分为两类:公路自行车和越野自行车，并将山地自行车子类别分配给越野自行车，将新的自行车子类别添加到越野自行车，并将公路自行车和旅游自行车分配给公路自行车类别。当“类别”和“子类别”属性具有灵活的关系类型时，您可以按照第 6 章“管理分析服务数据库”中的描述，通过将维作为更新进行处理，轻松地进行这种类型的更改，将成员从一个父代(自行车)重新分配到另一个父代(越野自行车)更新过程不需要您处理多维数据集，这意味着处理速度非常快。这种方法的缺点是，构建的任何聚合都会从数据库中删除，这反过来意味着查询会变慢，直到您以后可以花时间处理聚合。
*   **刚性**。严格的关系类型允许您在不丢失聚合的情况下对维度执行更新过程。但是，如果维表被更新以反映成员从一个父代移动到另一个父代的变化，则会引发错误并停止处理。因此，只有当您知道数据不太可能在以后重新排列时，才设置严格的关系。例如，在“日期”维度中，1 月 1 日始终以 1 月为父月，不会在以后分配给不同的月份，如 8 月。

### 父子层次结构

您可能需要在分析服务中创建的另一种层次类型是父子层次。在这种层次结构中，层次结构的级别来自自引用表中的内置关系，如 AdventureWorksDW2012 数据库中的**dimemploye**表。在该表中，**parentemployeeky**列与主键列**employeeky**有外键关系，如图 29 所示。

![](../Images/image031.jpg)

图 29:正确的属性关系

这种结构的好处是，不需要预先知道层次结构中存在多少个级别，也不必在维度中显式创建每个级别。这种结构非常灵活，最常用于组织结构图、财务应用程序中的会计科目表或制造应用程序中的物料清单。在 DSV 自动检测到表中的自引用连接，并且具有外键关系的属性显示在属性窗格中，带有特殊图标，如图 30 所示，以指示其**用法**属性设置为**父级**。

![](../Images/image032.png)

图 30:父属性

| ![](../Images/note.png) | 注意:每个维度只能有一个属性，其“用途”属性设置为“父项”。 |

父子层次结构的另一个好处是能够在非叶成员的事实表中存储数据。例如，在**factresellerselsales**表中，有像 Jae Pak 和 Linda Mitchell 这样的销售人员的销售交易，但也有与他们各自的经理 Amy Alberts 和 Stephen Jiang 相关联的交易。

您可以使用父属性的**MembersThreadata**属性来控制管理器的事实表数据是否可见。默认情况下，该属性设置为**真**，这意味着经理的销售数据在多维数据集中可见，如图 31 所示。

![](../Images/image033.jpg)

图 31:包含数据的父成员

您可以使用 **MembersWithDataCaption** 属性来区分经理的销售额和经理的员工和经理的销售额小计。使用星号作为成员名称的占位符，并附加一个字符串以包含在标题中，如图 32 所示。

![](../Images/image034.jpg)

图 32:带有数据的父成员的标题

另一种解决方案是通过将**成员的数据**属性更改为**非叶数据隐藏**来隐藏数据。然而，在这种情况下，经理的小计仍然是正确的，可以推断出经理的销售额，如图 33 所示。因此，这种技术不是一种安全措施，而只是在非叶维度成员存在事实记录时表示数据的一种替代方法。

![](../Images/image035.jpg)

图 33:查询结果中缺少父成员数据

## 属性类型

在维度向导中，您可以选择为每个属性分配一个属性类型。大多数情况下**常规**的默认值就足够了。但是，为了支持特定的业务场景，您可以分配不同的属性类型。

从默认值更改属性类型的最常见原因是识别与日期相关的属性。当日期属性可识别时，一些客户端工具可以基于日期执行计算。此外，某些 MDX 函数，如 QTD()或 YTD()，要求属性分别具有季度或年的属性类型。如果您有“帐户”维度，并且需要将帐户标识为资产、负债、收入和费用，以便指导分析服务如何按帐户类型正确聚合值，则您也可以更改属性类型。一些客户端工具识别城市或国家等地理属性类型，以支持在地图中显示立方体值。

您可以在**尺寸向导**中更改**属性类型**的值，或者在**属性**窗口中为每个属性设置**类型**属性。这两种方法都可能有点繁琐，所以第三种选择是使用**商业智能向导**，您可以通过单击**维度设计器**工具栏中的第一个按钮来启动该向导。然后在向导的**选择增强**页面选择**定义尺寸智能**选项，在**定义尺寸智能**页面选择**尺寸类型**。在后一个页面中，为维度中存在的每种属性类型选择复选框，并将标准属性类型映射到维度的属性，如图 34 所示。当您关闭向导时，您映射的每个属性的**类型**属性会更新以反映新的分配。

![](../Images/image036.jpg)

图 34:属性类型映射

## 翻译

如果需要支持多种语言以适应不同的用户，可以为维度配置翻译。尽管如果前端工具支持，此功能可以透明地工作，但分析服务不会自动执行翻译。您必须在维度的关系源中包含每个成员名称的翻译。对于每种语言和每个要翻译的属性，源代码必须包含一列，如图 35 所示。

![](../Images/image037.jpg)

图 35:维度表中的转换列

然后，您需要执行两个步骤来配置维度以使用翻译。首先，打开维度设计器的**翻译**标签，点击工具栏中的第三个按钮**新翻译**。然后，您必须为每个属性键入要显示的标题，如图 36 所示。

![](../Images/image038.jpg)

图 36:翻译标题

其次，单击平移与维度对象相交处的单元格，如属性列表中包含标题“ *Mes* ”的单元格，然后单击省略号按钮打开属性的**属性数据平移**对话框。在这个对话框中，您将属性映射到包含适用翻译的列，如图 37 所示。通过这种方式，您可以在分析服务数据库中添加您需要支持的任意多的语言。

![](../Images/image039.jpg)

图 37:翻译列映射