# 一、引言

## 介绍 T4

自 2005 年以来，T4 一直是 Visual Studio 的一部分。Visual Studio 的每个后续版本都进行了增量改进，因此它会越来越好。

| ![](img/note.png) | 注意:您可以在自己的应用程序中使用 Visual Studio 之外的 T4，但本书将重点介绍如何在 Visual Studio 中使用该工具包。 |

T4 是一个代码生成器。实际上，不止如此。T4 代表:

*   文本
*   模板
*   转换
*   工具包

请注意，代码和生成器都没有出现在名称中。T4 是基于模板中的文本，以及这些模板如何转化为有用的东西。在许多情况下，这涉及到将元数据应用于模板，以将其转换为各种语言的源代码。

T4 模板的一些可能输出:

*   C#
*   VB.Net
*   结构化查询语言
*   超文本标记语言
*   Java Script 语言
*   文本
*   半铸钢ˌ钢性铸铁(Cast Semi-Steel)

模板也有驱动转换的代码。这段代码可以用 C#或 VB 编写。NET，这取决于您最熟悉的语言，而不管输出的是什么类型的文本。

在本书中，我们将使用 C#来驱动转换，在生成代码时，我们将生成 C#，但这不是唯一的选项。

## 为什么生成代码？

熟悉代码生成工具是现代软件工程师的关键。我们需要编写的大部分代码都可以交给一个可信的代码生成器来为我们处理，坦率地说，我们的大部分时间都花在设计软件上，而不是处理重复代码的细微差别，因为计算机只需要很少的输入就可以编写这些代码。

在我们有很多重复的步骤可以很容易地用元数据描述的地方，或者在最佳实践还没有完全成型的地方，生成代码特别有用。人类对重复、乏味的任务感到厌烦和草率。计算机不会，当最佳实践仍在制定中时，生成代码是有意义的，这样随着最佳实践的改变，您只需改变生成器，使生成器生成的所有代码都符合不断发展的最佳实践。

我们还可以利用代码生成来启动一个项目。这种类型的代码生成不是生成永远不应该被更改的代码，而是期望在没有开发人员干预的情况下成功编译和运行，而是安排广泛的工作，并期望开发人员填充其余部分。这种类型的代码生成通常被称为脚手架。

脚手架非常适合提供开发人员指导，并确保您不必面对一个空的项目，不知道从哪里开始，但它无助于最佳实践的发展或元数据的更改。脚手架发电机预计只运行一次，开发人员从那里处理一切。它们提供了一个开始的催化剂。

## 实际应用

不管你是否知道，你可能已经在使用代码生成器了。许多工具和框架在幕后使用它们，使开发人员的生活更加轻松。

T4 越来越成为生成这些代码的首选工具。模板开发人员可以控制正在生成的代码，同时仍然允许作为模板用户的开发人员通过定制模板来修改生成的输出。

MVC 和实体框架可能是在幕后使用 T4 的两个最大的例子。实体框架期望其模板的输出是完整的和可用的，无需任何开发人员的干预。这些模板生成分部类，因此如果需要添加任何内容，请将其添加到单独文件中的分部类中。这将在代码重新生成时保护您的更改，并且可能经常重新生成。

MVC 采用脚手架方法来生成代码。对于您生成的任何工件，生成器都应该运行一次。这一代人是为了帮你落地跑步，但之后，你就靠自己了。您可以对生成的代码进行任何所需的更改，但是除非删除输出文件并重新开始，否则无法重新运行生成器。

正如我们将会看到的，这两种方法都有其优点和缺点。

## 实际应用

作为一个工具包，T4 允许你做任何你需要做的事情，但是有一些指导方针可以帮助我们在更容易获得代码生成好处的领域进行磨练:

*   您必须有一个易于获取、易于维护和保持干净的元数据来源。
*   生成的代码必须符合由可用元数据轻松定义的模式。
*   生成模板应该能够基于可用的元数据创建工件集合。

考虑到这些指导原则，我们可以根据您项目的性质确定几种可能的模板。如果您正在使用实体框架，那么您已经在使用 T4 了，但是如果您没有使用，那么有很多机会可以将 T4 引入到一个项目中，而不必完全改变您的数据访问逻辑。

一些应用包括:

*   自动将参数绑定到命令对象。
*   自动编写存储过程来封装对表的访问。
*   自动将数据表中的数据提取到概念验证中。

如果您已经在使用 MVC，那么您已经在使用 T4 作为脚手架——但是它可以为您做得更多，包括:

*   生成模型和视图(带有一点额外的元数据)。
*   生成 JavaScript 来自动调用 Web API 方法。
*   生成样式表的框架。

如果你没有使用 MVC，你可以从 MVC 使用 T4 的所有方式中获得灵感。

## 最低要求

自 2008 年以来，T4 已经集成到 Visual Studio 中，甚至可以作为单独的下载添加到 Visual Studio 2005 中。只要您使用的是 Visual Studio 2008 或更高版本，您就几乎拥有了所需的一切。我说几乎，是因为虽然 T4 内置于 Visual Studio 中，并且 Visual Studio 了解如何运行这些模板，但如果没有一个很好的扩展来提供一些急需的语法突出显示和智能感知，对编辑模板的支持是微不足道的。我建议从有形提供的社区版开始。社区版是免费的，将提供基本的语法突出显示，以及有限的智能感知支持。这足以让您开始，但是随着您的模板变得越来越复杂，您可以升级到专业版本，该版本将为您提供全面的智能感知支持，以及调试模板的能力。

| ![](img/note.png) | 注意:虽然这是我最喜欢的扩展，但它不是唯一可用的扩展。通过扩展管理器快速搜索会发现更多。 |

## 总结

在这一章中，我们已经介绍了大量的介绍性材料，这些材料为代码生成和 T4 特别适合您的项目提供了背景。我们已经概述了任何成功的代码生成应用程序应该具备的一些基本素质。我们回顾了两种不同的代码生成方法:一种是包含一切的方法，在这种方法中，生成器生成的代码永远不应该被开发人员修改；另一种是更简单的脚手架方法，其目标是简单地启动开发工作，但是依靠开发人员来填补空白。

我们回顾了一些当前的、活跃的例子，在这些例子中，你可能会看到 T4 在行动而没有意识到这一点:实体框架和 MVC。我们还简要介绍了一些示例应用程序，我们将在接下来的章节中更深入地探讨。

最后，我们已经看到了元数据对于生成代码有多重要的第一个提示。这本书的后半部分将着重于追踪这些元数据。